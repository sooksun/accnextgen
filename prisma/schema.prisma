generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== Enums ====================

enum CustomerType {
  COMPANY
  SCHOOL
  INDIVIDUAL
}

enum DocType {
  QUOTATION
  INVOICE
  TAX_INVOICE_RECEIPT
  DELIVERY_NOTE
}

enum OrderStatus {
  DRAFT
  INVOICED
  PAID
  CLOSED
  VOID
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  OTHER
}

enum ExpenseCategory {
  INVENTORY_PURCHASE
  SHIPPING_OUT
  PLATFORM_FEE
  MARKETING
  SOFTWARE_CLOUD
  SALARY_FREELANCE
  TRAVEL_COMM
  OFFICE_SUPPLIES
  OTHER
}

enum UserRole {
  ADMIN
  STAFF
}

enum ProductCategory {
  GOODS
  SERVICE
}

// ==================== Models ====================

model ProductGroup {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products Product[]

  @@index([sortOrder, name])
}

model Product {
  id          String          @id @default(cuid())
  sku         String?         @unique
  name        String
  description String?         @db.Text
  category    ProductCategory @default(GOODS)
  groupId     String?
  group       ProductGroup?   @relation(fields: [groupId], references: [id])
  unit        String          @default("ชิ้น")
  unitPrice   Decimal         @db.Decimal(12, 2)
  discount    Decimal?        @db.Decimal(12, 2)
  imageUrl    String?         @db.Text
  sourceUrl   String?         @db.Text
  scrapedAt   DateTime?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  orderItems    OrderItem[]
  documentItems DocumentItem[]

  @@index([name])
  @@index([category, isActive])
  @@index([groupId])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(STAFF)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Customer {
  id        String       @id @default(cuid())
  name      String
  type      CustomerType @default(COMPANY)
  taxId     String?
  address   String?      @db.Text
  email     String?
  phone     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  units     CustomerUnit[]
  orders    Order[]
  projects  Project[]
  documents Document[]

  @@index([name])
  @@index([type])
}

model CustomerUnit {
  id           String   @id @default(cuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name         String
  contactName  String?
  contactPhone String?
  contactEmail String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  projects Project[]

  @@index([customerId, name])
}

model Order {
  id         String      @id @default(cuid())
  code       String      @unique
  customerId String
  customer   Customer    @relation(fields: [customerId], references: [id])
  status     OrderStatus @default(DRAFT)
  orderDate  DateTime    @default(now())
  subTotal   Decimal     @db.Decimal(12, 2)
  vatRate    Decimal     @db.Decimal(5, 2)
  vatAmount  Decimal     @db.Decimal(12, 2)
  grandTotal Decimal     @db.Decimal(12, 2)
  note       String?     @db.Text
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  items       OrderItem[]
  shipment    Shipment?
  payments    Payment[]
  documents   Document[]
  attachments Attachment[]

  @@index([status, orderDate])
  @@index([customerId, orderDate])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  name      String
  unit      String   @default("ชิ้น")
  qty       Int      @default(1)
  unitPrice Decimal  @db.Decimal(12, 2)
  lineTotal Decimal  @db.Decimal(12, 2)
}

model Shipment {
  id          String    @id @default(cuid())
  orderId     String    @unique
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  carrier     String
  trackingNo  String?
  shippedAt   DateTime?
  shippingFee Decimal?  @db.Decimal(12, 2)
}

model Project {
  id         String        @id @default(cuid())
  code       String        @unique
  customerId String
  customer   Customer      @relation(fields: [customerId], references: [id])
  unitId     String?
  unit       CustomerUnit? @relation(fields: [unitId], references: [id])
  title      String
  startDate  DateTime?
  endDate    DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  milestones  ProjectMilestone[]
  documents   Document[]
  attachments Attachment[]

  @@index([customerId, unitId])
}

model ProjectMilestone {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title     String
  amount    Decimal  @db.Decimal(12, 2)
  dueDate   DateTime?
  isBilled  Boolean  @default(false)
}

model Document {
  id         String   @id @default(cuid())
  type       DocType
  number     String   @unique
  issueDate  DateTime @default(now())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  orderId    String?
  order      Order?   @relation(fields: [orderId], references: [id])
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id])
  subTotal   Decimal  @db.Decimal(12, 2)
  vatRate    Decimal  @db.Decimal(5, 2)
  vatAmount  Decimal  @db.Decimal(12, 2)
  grandTotal Decimal  @db.Decimal(12, 2)
  note       String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  items          DocumentItem[]
  withholdingTax WithholdingTax?
  attachments    Attachment[]
  payments       Payment[]

  @@index([type, issueDate])
  @@index([customerId, issueDate])
}

model DocumentItem {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  productId  String?
  product    Product? @relation(fields: [productId], references: [id])
  name       String
  description String? @db.Text
  unit       String   @default("ชิ้น")
  qty        Int      @default(1)
  unitPrice  Decimal  @db.Decimal(12, 2)
  lineTotal  Decimal  @db.Decimal(12, 2)
}

model Payment {
  id         String        @id @default(cuid())
  receivedAt DateTime      @default(now())
  method     PaymentMethod @default(TRANSFER)
  amount     Decimal       @db.Decimal(12, 2)
  note       String?       @db.Text
  orderId    String?
  order      Order?        @relation(fields: [orderId], references: [id])
  documentId String?
  document   Document?     @relation(fields: [documentId], references: [id])

  attachments Attachment[]

  @@index([receivedAt])
}

model WithholdingTax {
  id              String    @id @default(cuid())
  documentId      String    @unique
  document        Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  rate            Decimal   @db.Decimal(5, 2)
  baseAmount      Decimal   @db.Decimal(12, 2)
  taxAmount       Decimal   @db.Decimal(12, 2)
  certificateNo   String?
  certificateDate DateTime?
}

model Expense {
  id               String          @id @default(cuid())
  expenseDate      DateTime        @default(now())
  vendorName       String
  category         ExpenseCategory
  description      String?         @db.Text
  hasVat           Boolean         @default(false)
  subTotal         Decimal         @db.Decimal(12, 2)
  vatRate          Decimal         @db.Decimal(5, 2)
  vatAmount        Decimal         @db.Decimal(12, 2)
  grandTotal       Decimal         @db.Decimal(12, 2)
  paymentMethod    PaymentMethod   @default(TRANSFER)
  paidAmount       Decimal?        @db.Decimal(12, 2)
  relatedOrderId   String?
  relatedProjectId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  attachments Attachment[]

  @@index([expenseDate])
  @@index([category, expenseDate])
}

model Attachment {
  id         String   @id @default(cuid())
  fileName   String
  mimeType   String
  url        String
  uploadedAt DateTime @default(now())

  orderId    String?
  order      Order?    @relation(fields: [orderId], references: [id])
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id])
  expenseId  String?
  expense    Expense?  @relation(fields: [expenseId], references: [id])
  paymentId  String?
  payment    Payment?  @relation(fields: [paymentId], references: [id])
  projectId  String?
  project    Project?  @relation(fields: [projectId], references: [id])
}

model MonthlyClose {
  id       String   @id @default(cuid())
  year     Int
  month    Int
  closedAt DateTime @default(now())
  note     String?  @db.Text

  @@unique([year, month])
  @@index([year, month])
}

model MonthlySummary {
  id                 String   @id @default(cuid())
  year               Int
  month              Int
  revenueSubTotal    Decimal  @db.Decimal(12, 2)
  revenueVat         Decimal  @db.Decimal(12, 2)
  expenseSubTotal    Decimal  @db.Decimal(12, 2)
  expenseVat         Decimal  @db.Decimal(12, 2)
  vatOutput          Decimal  @db.Decimal(12, 2)
  vatInput           Decimal  @db.Decimal(12, 2)
  vatPayable         Decimal  @db.Decimal(12, 2)
  whtBaseAmount      Decimal  @db.Decimal(12, 2)
  whtTaxAmount       Decimal  @db.Decimal(12, 2)
  pnlRevenue         Decimal  @db.Decimal(12, 2)
  pnlCogs            Decimal  @db.Decimal(12, 2)
  pnlGrossProfit     Decimal  @db.Decimal(12, 2)
  pnlOpex            Decimal  @db.Decimal(12, 2)
  pnlOperatingProfit Decimal  @db.Decimal(12, 2)
  generatedAt        DateTime @default(now())

  @@unique([year, month])
}
